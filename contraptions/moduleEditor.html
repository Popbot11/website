<html>
    <head>
                                        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZMF5SZ58X2"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());

            gtag('config', 'G-ZMF5SZ58X2');
        </script>

        <style>
            .moduleMain{
                padding: 5px;
                border: 2px;
                margin: 2px;
                border-style: solid;
                border-color: rgb(94, 94, 94);
                background-color: rgba(0, 0, 0, 0.103);
                width:fit-content;
            }
            .moduleMini{
                /* padding: 5px; */
                /* border: 2px; */
                margin: 2px;
                border-style:dotted;
                border-color: rgb(143, 143, 143);
                background-color: rgba(0, 0, 0, 0.074);
                width:fit-content;
            }
            .tooltip{
                position: absolute;
                background-color: aqua;
            }
            input {
                min-width: 10px;
                width: 6ch;
            }
            button{
                border-radius: 0%;
            }
            .hide{
                visibility:visible;
            }
        </style>

        <!--BROKEN-->
        <script>
            class ExpandBox extends HTMLElement {
                constructor(){
                    super();
                }

            
                connectedCallback() {
                    var visible = false;

                    var target = document.getElementById(this.getAttribute("targetID"));
                    console.log(this.getAttribute("targetID"))
                    
                    target.hidden = !visible;

                    // this.hidden = true;
                    var button = document.createElement("button");
                    button.innerText = this.getAttribute("hiddenText");
                    button.onclick = function(){
                        var target = document.getElementById(this.getAttribute("targetID"));
                        visible = !visible;
                        target.hidden = visible;
                    };

                    // button.show = false;
                    this.appendChild(button);

                }
            }
            customElements.define("expand-box", ExpandBox);
        </script>


        <script>
            

            class ModuleData {
                constructor(params, accepts_submodules){
                    
                    this.params = params;
                    this.accepts_submodules = accepts_submodules;
                    
                }
            }

            var modulecount = 0;
            // var currentModule = "";

            //storing info for each module and how that works etc
            const modules = {
                "base": new ModuleData([], true),
                "level": new ModuleData(["gain"], false),
                "level_sig": new ModuleData([], true),
                "nesting_comb": new ModuleData(["delay", "feedback"], true),
                "nesting_allpass": new ModuleData(["delay", "feedback", "q"], true),
                "fdn": new ModuleData(["size"], true),
                "parallel": new ModuleData([], true),

            }


            // specifically info about wwhat modules take what other modules as inputs
            var chain = {
                "base0": ["base", [], 0],
            }

            function printChain(){
                console.log(chain);
            }

            //custom UI element for a module parameter
            class Parameter extends HTMLElement {
                constructor(){
                    super();
                }
                render() {
                    var name = this.getAttribute("name");
                    var info = this.getAttribute("info");

                    var numbox = document.createElement("input");
                    numbox.type="number";
                    numbox.name=name;
                    numbox.onkeypress = function() {numbox.style.width = numbox.value.length + 5 + 'ch'};

                    var tooltip = document.createElement("span");
                    tooltip.class = "tooltip"
                    tooltip.innerText = name;
                    if (info != "null"){
                        tooltip.innerText += "\n" + info;
                    }
                    tooltip.style="position:absolute;color:white;background-color:black;transform: translateY(20px);"
                
                    this.appendChild(numbox);
                    
                    this.onmouseover = function(){
                        this.appendChild(tooltip);
                        console.log(this)
                    };
                    this.onmouseleave = function(){this.removeChild(tooltip)};

                }
                connectedCallback() {
                    if (!this.rendered) {
                        this.render();
                        this.rendered = true;
                    }   
                }
            }
            customElements.define("param-", Parameter);

            class ModuleDropdown extends HTMLElement {
                constructor(){
                    super();
                }
                render() {
                    var parentModule = this.id;
                    var dropdown = document.createElement("div");
                    dropdown.style="position:absolute;left:"+this.getAttribute('data-pos-x')+"px;"
                    console.log(this.getAttribute('data-pos-x'))

                    var fuck = this.getAttribute('data-num')
                    // console.log("dropdown num: "+fuck);

                    for (var module in modules) {
                        // console.log(module);
                        var item = document.createElement("button")
                        item.style = "text-color: white;"   
                        item.innerText = module;
                        item.id = module;
                        
                        item.onclick = function(){
                            // console.log(parentModule + ", " + fuck+ ", "+event.target.id);
                            
                            modulecount += 1;
                            
                            chain[parentModule][1].push(event.target.id+modulecount);
                            chain[event.target.id+modulecount] = [event.target.id, [], modulecount];

                            var canvas = document.getElementById("canvas")
                            var parent = canvas.parentNode;
                            parent.removeChild(canvas);
                            parent.appendChild(
                                Object.assign(document.createElement("canvas-"), {
                                    id: "canvas", 
                                })
                            )

                        }

                        dropdown.appendChild(item);
                        dropdown.appendChild(document.createElement("br"));
                        
                    }
                    // console.log("id: "+this.id);
                    this.appendChild(dropdown);
                }
                connectedCallback() {
                    if (!this.rendered) {
                        this.render();
                        this.rendered = true;
                    }   
                }
            }
            customElements.define("module-dropdown", ModuleDropdown);
            //custom UI element for the button to add a new module
            class AddButton extends HTMLElement {
                constructor(){
                    super();
                }

                render() {
                    var button = document.createElement("button");
                    button.innerText = "add submodule";
                    
                    
                    // console.log("addbutton num: "+this.getAttribute('data-num'));
                    // var dropdown = document.createElement("a");
                    var dropdown = Object.assign(document.createElement("module-dropdown"), {id: this.id});
                    dropdown.setAttribute('data-num', this.getAttribute('data-num'));

                    // this.onmouseenter = function(){
                        
                    // }
                    
                    
                    this.onmouseover = function(){
                        
                        
                        // console.log(this.getAttribute('data-pos-x'));
                        dropdown.setAttribute('data-pos-x', event.clientX-15);
                        this.appendChild(dropdown)
                    };
                    

                    // this.onmouseover = function(){
                    //     this.appendChild(dropdown)
                    // };
                    this.onmouseleave = function(){
                        this.removeChild(dropdown)
                    };
                    // button.onclick = function(){console.log("clicked!!");};

                    this.appendChild(button);
                }
                connectedCallback() {
                    if (!this.rendered) {
                        this.render();
                        this.rendered = true;
                    }   
                }
            }
            customElements.define("add-button", AddButton);

            //custom UI element for the mini module thats added after you add a new module
            class ModuleMini extends HTMLElement {
                constructor(){
                    super();
                }
                render() {
                    var contents = document.createElement("span");
                    // console.log(this.getAttribute('data-sub-id'));
                    contents.innerText = " " +this.getAttribute('data-sub-id')+" ";
                    contents.className  = "moduleMini";

                    var deleteButton = document.createElement("button");
                    deleteButton.innerText = "x"
                    deleteButton.style="padding: 2px;"
                    
                    deleteButton.onclick = function(){
                        console.log("penis fart")
                    }

                    contents.appendChild(deleteButton);
                    
                    this.appendChild(contents);
                }
                connectedCallback() {
                    if (!this.rendered) {
                        this.render();
                        this.rendered = true;
                    }   
                }
            }
            customElements.define("module-mini", ModuleMini);

            //primary ui for singular module
            class ModuleMain extends HTMLElement {
                constructor(){
                    super();
                }
                render() {
                    // console.log(this.id)
                    this.setAttribute('data-num', chain[this.id][2]);
                    console.log(chain[this.id][2]+", "+this.id);
                    var selfName = this.id;
                    
                    // console.log("number: "+this.getAttribute('data-num'));
                    // console.log("rendering: "+selfName);
                    
                    var contents = document.createElement("div");
                    contents.className = "moduleMain";
                    
                    var divider = document.createElement("span");
                    divider.innerText = " | ";
                    
                    var title = document.createElement("span");
                    title.innerText = selfName + " | ";
                    contents.appendChild(title);
                    
                    if (modules[chain[this.id][0]].accepts_submodules){
                        var addButton = Object.assign(document.createElement("add-button"), {
                            id: this.id, 
                        }); 
                        addButton.setAttribute('data-num', this.getAttribute('data-num'))
                        contents.appendChild(addButton);

                        for (var sub of chain[this.id][1]){
                            var submodule = Object.assign(document.createElement("module-mini"), {
                                id: this.id,
                            });
                            submodule.setAttribute('data-sub-id', sub);
                            // submodule.setAttribute('data-index', sub);

                            contents.appendChild(submodule);
                        }
                        


                        // submodules.innerHTML = "balls"+modulecount;

                        contents.appendChild(divider);
                    }
                    
                    for (const value of modules[chain[this.id][0]].params){
                        var paramUI = (Object.assign(document.createElement("param-"), {
                            id: this.id, 
                            ['data-num']: this.num
                        }))
                        // console.log(value)
                        paramUI.setAttribute("name", value);
                        paramUI.setAttribute("info", "null");
                        // console.log(paramUI);
                        contents.appendChild(paramUI);
                    }

                    this.appendChild(contents);
                }
                connectedCallback() {
                    if (!this.rendered) {
                        this.render();
                        this.rendered = true;
                    }   
                }
            }
            customElements.define("module-main", ModuleMain);

            //ui for all modules in a connected list
            class Canvas extends HTMLElement {
                constructor(){
                    super();
                }
                render() {
                    for (let module in chain){
                        // console.log("thingy: "+module);
                        var ui = Object.assign(document.createElement("module-main"), {id: module});
                        // ui.id = module.name;
                        this.appendChild(ui);
                    }
                }
                connectedCallback() {
                    if (!this.rendered) {
                        this.render();
                        this.rendered = true;
                    }   
                }
            }
            customElements.define("canvas-", Canvas);

            var output = "";

           
        </script>
    </head>
    <body>
        <a href="../index.html">home</a><br><br>
        <p>
            a <b>WIP</b> experiment to make a general-purpose editor for text-based modular software. The two things I woudl immediately be able to use this for are my own project, buffer-gen, and the melda algorithms. I'm sure there's other things, though. ill keep this updated with a changelog maybe? idk. 
        </p>

        <!-- BROKEN BROKED BROKEN OH SO BROKEN
        
        <p id="changelog">changelog text (currently broken)</p>
        <expand-box hiddenText="show changelog" shownText="hide changelog" targetID="changelog"></expand-box> -->
        
        <hr size="5px" color="black">
        <span>Editor</span><br><br>
        <!-- ------------------ -->
         
        <!-- <div class="moduleMain" >
            
                nesting comb |
                <add-button></add-button> | 

                <param- info="amt between 0 and 1", name="feedback" ></param->
                <param- info="time in ms", name="delay" ></param->
        </div> -->

        <hr>
        <!-- <module-main id="base"></module-main> -->
        <div>
         <canvas- id="canvas"></canvas->
        </div>

        <hr size="5px" color="black">
        <span>Output:</span><br>


        <br>
        <button onclick="printChain()">print chain</button>
    </body>
</html>