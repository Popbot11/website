<html>
    <head>
                                        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZMF5SZ58X2"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());

            gtag('config', 'G-ZMF5SZ58X2');
        </script>

        <style>
            .moduleMain{
                padding: 5px;
                border: 2px;
                margin: 2px;
                border-style: solid;
                border-color: rgb(94, 94, 94);
                background-color: rgba(0, 0, 0, 0.103);
                width:fit-content;
            }
            .tooltip{
                position: absolute;
                background-color: aqua;
            }
            input {
                min-width: 10px;
                width: 6ch;
            }
            .hide{
                visibility:visible;
            }
        </style>

        <!--BROKEN-->
        <script>
            class ExpandBox extends HTMLElement {
                constructor(){
                    super();
                }

            
                connectedCallback() {
                    var visible = false;

                    var target = document.getElementById(this.getAttribute("targetID"));
                    console.log(this.getAttribute("targetID"))
                    
                    target.hidden = !visible;

                    // this.hidden = true;
                    var button = document.createElement("button");
                    button.innerText = this.getAttribute("hiddenText");
                    button.onclick = function(){
                        var target = document.getElementById(this.getAttribute("targetID"));
                        visible = !visible;
                        target.hidden = visible;
                    };

                    // button.show = false;
                    this.appendChild(button);

                }
            }
            customElements.define("expand-box", ExpandBox);
        </script>


        <script>
            class ModuleData {
                constructor(name, params, accepts_submodules){
                    this.name = name;
                    this.params = params;
                    this.accepts_submodules = accepts_submodules;
                }
            }

            var modulecount = 0;
            var currentModule = "";

            //storing info for each module and how that works etc
            const modules = {
                "nesting_comb": new ModuleData("", ["delay", "feedback"], true),
                "level": new ModuleData("", ["gain"], false)
            }


            // specifically info about wwhat modules take what other modules as inputs
            var chain = {

            }

            function printChain(){
                console.log(chain);
            }

            //custom UI element for a module parameter
            class Parameter extends HTMLElement {
                constructor(){
                    super();
                }
                render() {
                    var name = this.getAttribute("name");
                    var info = this.getAttribute("info");

                    var numbox = document.createElement("input");
                    numbox.type="number";
                    numbox.name=name;
                    numbox.onkeypress = function() {numbox.style.width = numbox.value.length + 5 + 'ch'};

                    var tooltip = document.createElement("span");
                    tooltip.class = "tooltip"
                    tooltip.innerText = name;
                    if (info != "null"){
                        tooltip.innerText += "\n" + info;
                    }
                    tooltip.style="position:absolute;color:white;background-color:black;transform: translateY(20px);"
                
                    this.appendChild(numbox);
                    
                    this.onmouseover = function(){
                        this.appendChild(tooltip);
                        console.log(this)
                    };
                    this.onmouseleave = function(){this.removeChild(tooltip)};

                }
                connectedCallback() {
                    if (!this.rendered) {
                        this.render();
                        this.rendered = true;
                    }   
                }
            }
            customElements.define("param-", Parameter);

            class ModuleDropdown extends HTMLElement {
                constructor(){
                    super();
                }
                render() {
                    var parentModule = this.id;
                    var dropdown = document.createElement("div");
                    dropdown.style="position:absolute;left:"+(event.pageX-15)+"px;"
                    for (var module in modules) {
                        // console.log(module);
                        var item = document.createElement("button")
                        item.style = "text-color: white;"   
                        item.innerText = module;
                        item.id = module;
                        
                        item.onclick = function(){
                            console.log(parentModule);
                            chain[parentModule] = event.target.id;
                            printChain();
                        }

                        dropdown.appendChild(item);
                        dropdown.appendChild(document.createElement("br"));
                        
                    }
                    console.log("id: "+this.id);
                    this.appendChild(dropdown);
                }
                connectedCallback() {
                    if (!this.rendered) {
                        this.render();
                        this.rendered = true;
                    }   
                }
            }
            customElements.define("module-dropdown", ModuleDropdown);
            //custom UI element for the button to add a new module
            class AddButton extends HTMLElement {
                constructor(){
                    super();
                }

                render() {
                    var button = document.createElement("button");
                    button.innerText = "add submodule";

                    var dropdown = Object.assign(document.createElement("module-dropdown"), {id: this.id});
                    

                    this.onmouseover = function(){this.appendChild(dropdown)};
                    this.onmouseleave = function(){this.removeChild(dropdown)};
                    button.onclick = function(){console.log("clicked!!");};

                    this.appendChild(button);
                }
                connectedCallback() {
                    if (!this.rendered) {
                        this.render();
                        this.rendered = true;
                    }   
                }
            }
            customElements.define("add-button", AddButton);

            //custom UI element for the mini module thats added after you add a new module
            class ModuleMini extends HTMLElement {
                constructor(){
                    super();
                }
                render() {
                    
                }
                connectedCallback() {
                    if (!this.rendered) {
                        this.render();
                        this.rendered = true;
                    }   
                }
            }
            customElements.define("module-mini", ModuleMini);

            //primary ui for singular module
            class ModuleMain extends HTMLElement {
                constructor(){
                    super();
                }
                render() {
                    console.log("rendering: "+this.id+" module");

                    var contents = document.createElement("div");
                    contents.className = "moduleMain";

                    var divider = document.createElement("span");
                    divider.innerText = " | "

                    var title = document.createElement("span");
                    title.innerText = this.id + " | "
                    contents.appendChild(title);

                    if (modules[this.id].accepts_submodules){
                        var addButton = Object.assign(document.createElement("add-button"), {id: this.id});
                        // addButton.id = this.id;
                        contents.appendChild(addButton);
                        contents.appendChild(divider);
                    }
                    

                    for (const value of modules[this.id].params){
                        var paramUI = (document.createElement("param-"))
                        // console.log(value)
                        paramUI.setAttribute("name", value);
                        paramUI.setAttribute("info", "null");
                        console.log(paramUI);
                        contents.appendChild(paramUI);
                    }

                    this.appendChild(contents);
                }
                connectedCallback() {
                    if (!this.rendered) {
                        this.render();
                        this.rendered = true;
                    }   
                }
            }
            customElements.define("module-main", ModuleMain);

            //ui for all modules in a connected list
            class Canvas extends HTMLElement {
                constructor(){
                    super();
                }
                render() {
                    
                }
                connectedCallback() {
                    if (!this.rendered) {
                        this.render();
                        this.rendered = true;
                    }   
                }
            }
            customElements.define("canvas-", Canvas);

            var output = "";

                    
        </script>
    </head>
    <body>
        <a href="../index.html">home</a><br><br>
        <p>
            a <b>WIP</b> experiment to make a general-purpose editor for text-based modular software. The two things I woudl immediately be able to use this for are my own project, buffer-gen, and the melda algorithms. I'm sure there's other things, though. ill keep this updated with a changelog maybe? idk. 
        </p>

        <!-- BROKEN BROKED BROKEN OH SO BROKEN
        
        <p id="changelog">changelog text (currently broken)</p>
        <expand-box hiddenText="show changelog" shownText="hide changelog" targetID="changelog"></expand-box> -->
        
        <hr size="5px" color="black">
        <span>Editor</span><br><br>
        <!-- ------------------ -->
         
        <!-- <div class="moduleMain" >
            
                nesting comb |
                <add-button></add-button> | 

                <param- info="amt between 0 and 1", name="feedback" ></param->
                <param- info="time in ms", name="delay" ></param->
        </div> -->

        <hr>
        <module-main id="nesting_comb"></module-main>

        <hr size="5px" color="black">
        <span>Output:</span><br>


        <br>
        <button onclick="printChain()">print chain</button>
    </body>
</html>